const listEl=document.getElementById('list');const form=document.getElementById('reviewForm');const ratingInput=document.getElementById('rating');const stars=Array.from(document.querySelectorAll('.star'));function paintStars(n){stars.forEach((el,i)=>{el.textContent=i<n?'★':'☆';});}stars.forEach(s=>s.addEventListener('click',()=>{const v=Number(s.dataset.v);ratingInput.value=v;paintStars(v);}));paintStars(Number(ratingInput.value||5));const usageMap={owned:'Własny',rented:'Wynajem',testdrive:'Jazda próbna',other:'Inne'};const fuelMap={petrol:'Benzyna',diesel:'Diesel',hybrid:'Hybryda',electric:'Elektryczny'};const gearboxMap={manual:'Manual',auto:'Automat'};const conditionMap={excellent:'Bardzo dobry',good:'Dobry',fair:'Średni',poor:'Słaby'};const bodyMap={sedan:'Sedan',kombi:'Kombi',hatchback:'Hatchback',suv:'SUV',coupe:'Coupé',van:'Van'};const API={load:'load_reviews.php',save:'save_review.php',del:'delete_review.php'};async function apiLoad(){const r=await fetch(API.load);const d=await r.json();if(!r.ok||!d.ok)throw new Error(d.error||'Load error');return d.items||[]}async function apiSave(o){const r=await fetch(API.save,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(o)});const d=await r.json();if(!r.ok||!d.ok)throw new Error(d.error||'Save error');return d}async function apiDelete(id){const r=await fetch(API.del,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});const d=await r.json();if(!r.ok||!d.ok)throw new Error(d.error||'Delete error');return d}function renderItems(items){listEl.innerHTML='';if(!items.length){const div=document.createElement('div');div.className='empty';div.textContent='Na razie brak opinii.';listEl.appendChild(div);return}items.forEach(x=>{const it=document.createElement('div');it.className='item';const h=document.createElement('h3');h.textContent=`${x.make} ${x.model} • ${x.year}`;const meta=document.createElement('div');meta.className='meta';const d=x.date||new Date(x.created_at||Date.now()).toLocaleDateString('pl-PL');const usageTxt=usageMap[x.usage]||'—';const fuelTxt=fuelMap[x.fuel]||x.fuel||'—';const gearboxTxt=gearboxMap[x.gearbox]||'—';const conditionTxt=conditionMap[x.condition]||'—';const bodyTxt=bodyMap[x.bodytype]||'—';meta.innerHTML=`<span class="tag">${usageTxt}</span> <span class="tag">${fuelTxt}</span> <span class="tag">${gearboxTxt}</span> <span class="tag">${conditionTxt}</span> <span class="tag">${bodyTxt}</span> <span class="tag">Ocena: ${'★'.repeat(Number(x.rating))}${'☆'.repeat(5-Number(x.rating))}</span> <span style="margin-left:6px">${d}${x.author?' • '+x.author:''}</span>`;const p=document.createElement('p');p.textContent=x.comment||'';const btns=document.createElement('div');btns.className='btns';const del=document.createElement('button');del.className='btn-ghost';del.type='button';del.textContent='Usuń';del.addEventListener('click',async()=>{if(!confirm('Usunąć opinię?'))return;await apiDelete(x.id);await refresh()});btns.appendChild(del);it.appendChild(h);it.appendChild(meta);it.appendChild(p);it.appendChild(btns);listEl.appendChild(it)})}async function refresh(){try{const items=await apiLoad();renderItems(items)}catch(e){console.error(e);listEl.innerHTML='<div class="empty">Błąd ładowania danych.</div>'}}form.addEventListener('submit',async e=>{e.preventDefault();const fd=new FormData(form);const obj=Object.fromEntries(fd.entries());obj.rating=Number(obj.rating||5);if(!obj.make||!obj.model||!obj.year){alert('Uzupełnij proszę pola: Marka, Model i Rok.');return}try{await apiSave(obj);form.reset();const today=new Date().toISOString().slice(0,10);form.querySelector('input[name="date"]').value=today;ratingInput.value=5;paintStars(5);await refresh()}catch(e){alert('Nie udało się zapisać opinii. Sprawdź konfigurację bazy.')}});document.getElementById('clearAll').addEventListener('click',async()=>{alert('Aby wyczyścić wszystkie opinie, użyj phpMyAdmin (TRUNCATE TABLE reviews).')});form.querySelector('input[name="year"]').value=new Date().getFullYear();form.querySelector('input[name="date"]').value=new Date().toISOString().slice(0,10);refresh();